# Overview

This repo was created to provide a reproduction of a possible bug in Turborepo.

There are two folders in this project:

## monorepo

This was generated by running:

```bash
npx create-turbo@latest
yarn set version berry
```

All of the code in `monorepo` is what comes by default from running the commands above.

**The only manual change is a resolution for `ajv` in the root package.json.**

```json
  "resolutions": {
    "ajv": "^8"
  },
```

Running turbo prune generated the `out/` directory.

```bash
yarn turbo prune --scope=web --docker
```

## pruned

The code in this folder is the result of running turbo prune and moving the code to its own directory.

```bash
mkdir pruned
cp monorepo/out/yarn.lock pruned/yarn.lock
cp monorepo/.yarnrc.yml pruned/.yarnrc.yml
cp -r monorepo/out/json/* pruned
cp -r monorepo/.yarn pruned/.yarn
```

# Bug Report

## What version of Turborepo are you using?

`1.6.3`

## What package manager are you using / does the bug impact

`Yarn 3.3.0`

## What operating system are you using

Mac (intel)

## Describe the bug

To optimize our Docker builds we are attempting to use turbo prune to create a lighter weight image. After copying the lockfile and the package.json files to our image we need to install our dependencies with the `--immutable` flag to ensure that our dependencies will not change. We have observed that when we include yarn resolutions in our root package.json in our monorepo we are unable to run `yarn --immutable` successfully in our _pruned_ monorepo.

To reproduce this bug you can follow the steps listed in the `Overview` above, or you can clone this repo and observe that running `yarn --immutable` from `pruned/` fails because the lockfile will be modified.

<img src="/screenshots/yarn-output.png" alt="yarn output" width="60%"/>
